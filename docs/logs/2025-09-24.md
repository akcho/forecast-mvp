# 2025-09-24

## Forecast Tab Instant Redirect Issue - RESOLVED

**Problem**: Forecast tab was instantly redirecting to QuickBooks "Not Connected" status page while Drivers and Reports tabs worked properly.

**Root Cause**:
The forecast page was checking QuickBooks connection status immediately when user authenticated, without waiting for company selection. This caused the connection check to fail because:

1. **Forecast page** (broken): Called `/api/quickbooks/status` without `company_id` parameter as soon as `session?.user?.dbId` was available
2. **Reports page** (working): Only called `/api/quickbooks/status?company_id=${selectedCompanyId}` when BOTH `session?.user?.dbId` AND `selectedCompanyId` were available
3. **Drivers page** (working): Similar pattern to forecast but simpler implementation without company context

**Investigation Process**:
1. First suspected duplicate connection checking in `ForecastDashboard` component - removed redundant check but issue persisted
2. Compared page implementations with `diff` commands - found forecast page had unique `autoRedirectToSandbox()` logic
3. Investigated environment detection logic - not the cause (only affects localhost)
4. Discovered company context usage inconsistency - **this was the real issue**

**Technical Details**:
- Reports page uses `useCompany()` hook and waits for `selectedCompanyId` before connection check
- Forecast page was missing company context and checking connection too early
- Status API behaves differently with/without `company_id` parameter
- Without company selection, connection check fails and triggers redirect to login

**Solution Applied**:
Updated `/src/app/forecast/page.tsx`:
1. Added `useCompany()` hook to get `selectedCompanyId`
2. Split OAuth handling and connection checking into separate `useEffect` hooks
3. Connection check now waits for both `session?.user?.dbId && selectedCompanyId`
4. Status API call includes `company_id=${selectedCompanyId}` parameter
5. Matches reports page pattern exactly

**Commits**:
- `c47c94d`: Fix forecast tab redirect issue by removing duplicate connection check (partial fix)
- `d26fd89`: Fix forecast tab instant redirect by matching reports page pattern (complete fix)

**Lesson Learned**: When debugging component behavior differences, check for inconsistent dependency patterns in `useEffect` hooks and context usage, not just business logic differences.
